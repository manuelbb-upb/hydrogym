Bootstrap: docker
From: firedrakeproject/firedrake-complex:latest
Stage: complex

Bootstrap: docker
From: firedrakeproject/firedrake:latest
Stage: real

%files from complex
  /home/firedrake/firedrake /home/firedrake/firedrake-complex

%files
  ./../hydrogym /home/hydrogym
  ./../examples /home/hydrogym/examples
  ./../setup.py /home/hydrogym
  ./../requirements.txt /home/hydrogym

%post
  # apt upgrade # this is done in the Docker file, but do we need to?
  apt update
  apt install -y libhdf5-dev libxcursor-dev libxinerama1
  # apt install -y texlive # did not see where texlive is needed

  export VENV=/home/firedrake/firedrake
  export VENV_COMPLEX=/home/firedrake/firedrake-complex

  # Install dependencies
  bash -c ". $VENV/bin/activate && pip install --upgrade pip setuptools"
  bash -c ". $VENV_COMPLEX/bin/activate && pip install --upgrade pip setuptools"

  # Install hydrogym package
  bash -c ". $VENV/bin/activate && pip install -e /home/hydrogym"
  bash -c ". $VENV_COMPLEX/bin/activate && pip install -e /home/hydrogym"

  # Install an iPython kernel for firedrake (https://github.com/firedrakeproject/firedrake/blob/master/docker/Dockerfile.jupyter)
  #  TODO: THIS SHOULD BE IN AN EXTERNAL FILE...
  bash -c ". $VENV/bin/activate && pip install -r /home/hydrogym/requirements.txt"
  bash -c ". $VENV_COMPLEX/bin/activate && pip install -r /home/hydrogym/requirements.txt"
  bash -c ". $VENV/bin/activate && jupyter nbextension enable --py widgetsnbextension --sys-prefix"
  bash -c ". $VENV_COMPLEX/bin/activate && jupyter nbextension enable --py widgetsnbextension --sys-prefix"

%environment
  export VENV=/home/firedrake/firedrake
  export VENV_COMPLEX=/home/firedrake/firedrake-complex
  export ENV OMP_NUM_THREADS=1
