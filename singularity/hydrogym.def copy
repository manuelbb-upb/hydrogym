Bootstrap: docker
From: firedrakeproject/firedrake-env:latest

%files
  ./../hydrogym /home/hydrogym
  ./../setup.py /home/hydrogym
  ./../requirements.txt /home/hydrogym

%post
  # apt upgrade # this is done in the Docker file, but do we need to?
  apt update
  apt install -y libhdf5-dev libxcursor-dev libxinerama1 texlive wget

  mkdir -p /home/firedrake
  cd /home/firedrake

  # Install Firedrake and components
  curl -O https://raw.githubusercontent.com/firedrakeproject/firedrake/master/scripts/firedrake-install
  bash -c "PETSC_CONFIGURE_OPTIONS='--download-fftw=1' python3 firedrake-install --no-package-manager --disable-ssh --remove-build-files --pip-install scipy"

  export VENV=/home/firedrake/firedrake

  # Install the complex version of firedrake (not differentiable, but useful for stability analysis)
  bash -c "PETSC_CONFIGURE_OPTIONS='--download-fftw=1' python3 firedrake-install --no-package-manager --disable-ssh --remove-build-files --pip-install scipy --complex --venv-name=firedrake-complex"
  export VENV_COMPLEX=/home/firedrake/firedrake-complex

  bash -c ". $VENV/bin/activate; firedrake-update --documentation-dependencies --tinyasm --slepc --install thetis --install gusto --install icepack --install irksome --install femlium"
  bash -c ". $VENV_COMPLEX/bin/activate; firedrake-update --documentation-dependencies --tinyasm --slepc --install thetis --install gusto --install icepack --install irksome --install femlium"

  # Install dependencies
  bash -c ". $VENV/bin/activate && pip install --upgrade pip setuptools"
  bash -c ". $VENV_COMPLEX/bin/activate && pip install --upgrade pip setuptools"

  # Install hydrogym package
  bash -c ". $VENV/bin/activate && pip install -e /home/hydrogym"
  bash -c ". $VENV_COMPLEX/bin/activate && pip install -e /home/hydrogym"

  # Install an iPython kernel for firedrake (https://github.com/firedrakeproject/firedrake/blob/master/docker/Dockerfile.jupyter)
  #  TODO: THIS SHOULD BE IN AN EXTERNAL FILE...
  bash -c ". $VENV/bin/activate && pip install -r /home/hydrogym/requirements.txt"
  bash -c ". $VENV_COMPLEX/bin/activate && pip install -r /home/hydrogym/requirements.txt"
  bash -c ". $VENV/bin/activate && jupyter nbextension enable --py widgetsnbextension --sys-prefix"
  bash -c ". $VENV_COMPLEX/bin/activate && jupyter nbextension enable --py widgetsnbextension --sys-prefix"

%environment
  export VENV=/home/firedrake/firedrake
  export VENV_COMPLEX=/home/firedrake/firedrake-complex
  export ENV OMP_NUM_THREADS=1
